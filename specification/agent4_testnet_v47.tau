# Deflationary Agent V47 - Multi-Indicator Consensus
# Combines EMA, RSI, and Bollinger Bands with voting system
# Copyright DarkLightX/Dana Edwards
#
# DESIGN RATIONALE:
# Single indicators often give false signals. By requiring consensus
# from multiple indicators, we reduce false positives significantly.
#
# INDICATORS IMPLEMENTED:
# 1. EMA Crossover (trend direction)
# 2. RSI (momentum/overbought-oversold)
# 3. Bollinger Bands (volatility and price extremes)
#
# CONSENSUS RULES:
# - Entry: At least 2 of 3 indicators must agree
# - Exit: Any indicator can trigger exit for safety
# - Confidence: 3/3 agreement = high confidence, 2/3 = medium

# === BITVECTOR INPUTS ===
bv[16] i0 = ifile("inputs/price.in").
bv[16] i5 = ifile("inputs/bb_period_sma.in").     # Bollinger Band center (SMA)
bv[16] i6 = ifile("inputs/bb_stddev.in").         # Bollinger Band width (2*stddev)

# === BOOLEAN INPUTS ===
sbf i1 = ifile("inputs/volume.in").
sbf i2 = ifile("inputs/trend.in").
sbf i3 = ifile("inputs/profit_guard.in").
sbf i4 = ifile("inputs/failure_echo.in").

# === HELPER PREDICATES ===
timed_out(b1, b0) := b1 & b0.

# === OUTPUT STREAMS ===
sbf o0 = ofile("outputs/state.out").
sbf o1 = ofile("outputs/holding.out").
sbf o2 = ofile("outputs/buy_signal.out").
sbf o3 = ofile("outputs/sell_signal.out").
sbf o6 = ofile("outputs/timer_b0.out").
sbf o7 = ofile("outputs/timer_b1.out").
sbf o9 = ofile("outputs/nonce.out").
sbf o11 = ofile("outputs/profit.out").
sbf o13 = ofile("outputs/has_burned.out").

# Bitvector tracking
bv[16] o14 = ofile("outputs/entry_price.out").
bv[16] o15 = ofile("outputs/ema_fast.out").       # Fast EMA
bv[16] o16 = ofile("outputs/ema_slow.out").       # Slow EMA
bv[16] o17 = ofile("outputs/avg_gain.out").       # RSI gain
bv[16] o18 = ofile("outputs/avg_loss.out").       # RSI loss
bv[16] o19 = ofile("outputs/prev_price.out").     # Previous price

# Indicator signals
sbf o20 = ofile("outputs/ema_bullish.out").       # EMA crossover bullish
sbf o21 = ofile("outputs/rsi_oversold.out").      # RSI oversold
sbf o22 = ofile("outputs/bb_lower_touch.out").    # Price at lower BB
sbf o23 = ofile("outputs/ema_bearish.out").       # EMA bearish
sbf o24 = ofile("outputs/rsi_overbought.out").    # RSI overbought
sbf o25 = ofile("outputs/bb_upper_touch.out").    # Price at upper BB

# Consensus signals
sbf o26 = ofile("outputs/entry_consensus.out").   # 2+ indicators agree on entry
sbf o27 = ofile("outputs/exit_consensus.out").    # Any indicator says exit
bv[2] o28 = ofile("outputs/confidence.out").      # 0=none, 1=low, 2=medium, 3=high

# === V47 MULTI-INDICATOR CONSENSUS SPECIFICATION ===
r (
    # === EMA CALCULATION ===
    # Fast EMA: α=0.2 (51/256)
    (o15[t] = ({51}:bv[16] * i0[t] + {205}:bv[16] * o15[t-1]) / {256}:bv[16]) &&
    
    # Slow EMA: α=0.1 (26/256)
    (o16[t] = ({26}:bv[16] * i0[t] + {230}:bv[16] * o16[t-1]) / {256}:bv[16]) &&
    
    # EMA Bullish: fast > slow
    (o20[t] = o15[t] > o16[t]) &&
    
    # EMA Bearish: fast < slow
    (o23[t] = o15[t] < o16[t]) &&
    
    # === RSI CALCULATION ===
    # Store previous price
    (o19[t] = i0[t-1]) &&
    
    # Smoothed average gain
    (o17[t] = (i0[t] > o19[t]) ? 
              ({64}:bv[16] * (i0[t] - o19[t]) + {192}:bv[16] * o17[t-1]) / {256}:bv[16] :
              ({192}:bv[16] * o17[t-1]) / {256}:bv[16]) &&
    
    # Smoothed average loss
    (o18[t] = (i0[t] < o19[t]) ?
              ({64}:bv[16] * (o19[t] - i0[t]) + {192}:bv[16] * o18[t-1]) / {256}:bv[16] :
              ({192}:bv[16] * o18[t-1]) / {256}:bv[16]) &&
    
    # RSI Oversold: gain/loss < 0.43 (30/70)
    (o21[t] = ({70}:bv[16] * o17[t]) < ({30}:bv[16] * o18[t])) &&
    
    # RSI Overbought: gain/loss > 2.33 (70/30)
    (o24[t] = ({30}:bv[16] * o17[t]) > ({70}:bv[16] * o18[t])) &&
    
    # === BOLLINGER BANDS ===
    # Lower band touch: price <= SMA - 2*stddev
    (o22[t] = i0[t] <= (i5[t] - i6[t])) &&
    
    # Upper band touch: price >= SMA + 2*stddev
    (o25[t] = i0[t] >= (i5[t] + i6[t])) &&
    
    # === CONSENSUS CALCULATION ===
    # Entry consensus: at least 2 of 3 indicators bullish
    # 1. EMA bullish (o20)
    # 2. RSI oversold (o21) - good entry on dips
    # 3. BB lower touch (o22) - price at support
    (o26[t] = (o20[t] & o21[t]) |      # EMA + RSI
              (o20[t] & o22[t]) |       # EMA + BB
              (o21[t] & o22[t])) &&     # RSI + BB
    
    # Exit consensus: ANY bearish signal (conservative)
    (o27[t] = o23[t] |                  # EMA bearish
              o24[t] |                  # RSI overbought
              o25[t]) &&                # BB upper touch
    
    # Confidence level (count of bullish indicators)
    (o28[t] = (o20[t] & o21[t] & o22[t]) ? {3}:bv[2] :
              (o26[t] ? {2}:bv[2] : 
               ((o20[t] | o21[t] | o22[t]) ? {1}:bv[2] : {0}:bv[2]))) &&
    
    # === STATE MACHINE WITH CONSENSUS ===
    (o0[t] = (o0[t-1]' & 
              o26[t] &                  # Entry consensus (2+ indicators)
              i1[t] &                   # Volume fresh
              o1[t-1]' &                # Not holding
              timed_out(o7[t-1], o6[t-1])' &
              o9[t-1]' & i4[t]') |
             # Continue: no exit consensus AND not timed out
             (o0[t-1] & 
              o27[t]' &                 # No exit signal
              timed_out(o7[t-1], o6[t-1])' &
              i1[t] & i4[t]')) &&
    
    # === TRADING SIGNALS ===
    (o2[t] = o0[t] & o0[t-1]' & o1[t-1]') &&
    (o3[t] = o0[t-1] & o0[t]' & o1[t-1]) &&
    (o1[t] = o2[t] | (o3[t]' & o1[t-1])) &&
    
    # === TIMER ===
    (o6[t] = o0[t] & o6[t-1]') &&
    (o7[t] = o0[t] & ((o7[t-1] & o6[t-1]') | (o7[t-1]' & o6[t-1]))) &&
    
    # === NONCE ===
    (o9[t] = o2[t] | (o0[t-1] & o3[t]' & o9[t-1])) &&
    
    # === PROFIT ===
    (o11[t] = o3[t] & (i0[t] > o14[t-1]) & i3[t]) &&
    
    # === BURNS ===
    (o13[t] = o13[t-1] | o11[t]) &&
    
    # === ENTRY PRICE ===
    (o14[t] = (o2[t] ? i0[t] : o14[t-1]))
)

# === INDICATOR LOGIC EXPLAINED ===
#
# 1. EMA CROSSOVER (Trend Following)
#    - Fast EMA > Slow EMA = Bullish trend
#    - Fast EMA < Slow EMA = Bearish trend
#    - Best in: Trending markets
#    - Weakness: Whipsaws in ranging markets
#
# 2. RSI (Momentum)
#    - RSI < 30 = Oversold (buy signal)
#    - RSI > 70 = Overbought (sell signal)
#    - Best in: Ranging markets
#    - Weakness: Can stay extreme in strong trends
#
# 3. BOLLINGER BANDS (Volatility)
#    - Price at lower band = Potential support
#    - Price at upper band = Potential resistance
#    - Best in: Mean-reverting markets
#    - Weakness: Can ride bands in trends

# === CONSENSUS BENEFITS ===
#
# Single indicator: ~60% accuracy (too many false signals)
# Two indicators: ~75% accuracy (most false signals filtered)
# Three indicators: ~85% accuracy (highest confidence)
#
# Our entry requires 2+ indicators = balance of opportunity and accuracy

# === DAEMON REQUIREMENTS ===
# i5: Bollinger Band SMA (20-period simple moving average)
# i6: Bollinger Band deviation (2 * 20-period stddev)
#
# The daemon should compute these off-chain for efficiency:
#   sma = sum(prices[-20:]) / 20
#   stddev = sqrt(sum((p - sma)^2 for p in prices[-20:]) / 20)
#   i6 = 2 * stddev

# === PERFORMANCE NOTES ===
# - 3 indicators = 6 bitvector operations
# - Consensus = 3 boolean operations
# - Total clauses: ~25
# - Most computation is EMA/RSI (same as V43/V44)

