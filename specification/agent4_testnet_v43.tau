# Deflationary Agent V43 - EMA Crossover Trend Detection
# Implements in-specification moving average crossover strategy
# Copyright DarkLightX/Dana Edwards
#
# TECHNICAL INDICATOR: Exponential Moving Average (EMA) Crossover
# - Fast EMA (α=0.2): Responds quickly to price changes
# - Slow EMA (α=0.1): Smooths out noise, shows trend
# - Entry when fast > slow (uptrend starting)
# - Exit when fast < slow (uptrend ending)
#
# IMPLEMENTATION:
# Using fixed-point arithmetic scaled by 256 to avoid floating point:
#   EMA = α * price + (1-α) * EMA_prev
#   Fast: α=0.2 ≈ 51/256, (1-α)=0.8 ≈ 205/256
#   Slow: α=0.1 ≈ 26/256, (1-α)=0.9 ≈ 230/256

# === BITVECTOR INPUTS ===
bv[16] i0 = ifile("inputs/price.in").            # Current price
bv[16] i5 = ifile("inputs/entry_threshold.in").  # Entry threshold (fallback)
bv[16] i6 = ifile("inputs/exit_threshold.in").   # Exit threshold (fallback)

# === BOOLEAN INPUTS (unchanged) ===
sbf i1 = ifile("inputs/volume.in").
sbf i2 = ifile("inputs/trend.in").
sbf i3 = ifile("inputs/profit_guard.in").
sbf i4 = ifile("inputs/failure_echo.in").

# === EMA COMPUTATION VIA RECURRENCE RELATIONS ===
# Fast EMA: α = 51/256 ≈ 0.2
# ema_fast = (51 * price + 205 * ema_fast_prev) / 256
#
# NOTE: In tau-lang, recurrence relations use [n] indexing.
# We define EMA as functions of the stream at time t.

# === BOOLEAN HELPER PREDICATES ===
timed_out(b1, b0) := b1 & b0.

# === OUTPUT STREAMS ===
sbf o0 = ofile("outputs/state.out").
sbf o1 = ofile("outputs/holding.out").
sbf o2 = ofile("outputs/buy_signal.out").
sbf o3 = ofile("outputs/sell_signal.out").
sbf o6 = ofile("outputs/timer_b0.out").
sbf o7 = ofile("outputs/timer_b1.out").
sbf o9 = ofile("outputs/nonce.out").
sbf o11 = ofile("outputs/profit.out").
sbf o13 = ofile("outputs/has_burned.out").

# Bitvector outputs for EMA tracking
bv[16] o14 = ofile("outputs/entry_price.out").
bv[16] o15 = ofile("outputs/ema_fast.out").      # Fast EMA value
bv[16] o16 = ofile("outputs/ema_slow.out").      # Slow EMA value

# Trend signal output
sbf o17 = ofile("outputs/uptrend.out").          # 1 = fast > slow

# === V43 EMA CROSSOVER SPECIFICATION ===
r (
    # === EMA CALCULATION ===
    # Fast EMA: (51 * price + 205 * prev_ema) / 256
    # Using bitvector arithmetic
    (o15[t] = ({51}:bv[16] * i0[t] + {205}:bv[16] * o15[t-1]) / {256}:bv[16]) &&
    
    # Slow EMA: (26 * price + 230 * prev_ema) / 256
    (o16[t] = ({26}:bv[16] * i0[t] + {230}:bv[16] * o16[t-1]) / {256}:bv[16]) &&
    
    # Uptrend signal: fast EMA > slow EMA
    (o17[t] = o15[t] > o16[t]) &&
    
    # === STATE MACHINE WITH EMA CROSSOVER ===
    # Entry: uptrend starting (fast crosses above slow)
    # Plus standard entry conditions
    (o0[t] = (o0[t-1]' & 
              o17[t] & o17[t-1]' &  # Golden cross: uptrend just started
              i0[t] < o15[t] &      # Price below fast EMA (pullback)
              i1[t] &               # Volume fresh
              i2[t] &               # Trend bullish
              o1[t-1]' &            # Not holding
              timed_out(o7[t-1], o6[t-1])' & 
              o9[t-1]' & i4[t]') |
             # Continue: still in uptrend
             (o0[t-1] & 
              o17[t] &              # Still uptrend
              timed_out(o7[t-1], o6[t-1])' & 
              i1[t] & i4[t]')) &&
    
    # Exit when uptrend ends (death cross)
    # Implicit in state machine: exit when o17=0
    
    # === TRADING SIGNALS ===
    (o2[t] = o0[t] & o0[t-1]' & o1[t-1]') &&
    (o3[t] = o0[t-1] & o0[t]' & o1[t-1]) &&
    (o1[t] = o2[t] | (o3[t]' & o1[t-1])) &&
    
    # === TIMER ===
    (o6[t] = o0[t] & o6[t-1]') &&
    (o7[t] = o0[t] & ((o7[t-1] & o6[t-1]') | (o7[t-1]' & o6[t-1]))) &&
    
    # === NONCE ===
    (o9[t] = o2[t] | (o0[t-1] & o3[t]' & o9[t-1])) &&
    
    # === PROFIT ===
    (o11[t] = o3[t] & (i0[t] > o14[t-1]) & i3[t]) &&
    
    # === BURNS ===
    (o13[t] = o13[t-1] | o11[t]) &&
    
    # === ENTRY PRICE CAPTURE ===
    (o14[t] = (o2[t] ? i0[t] : o14[t-1]))
)

# === EMA CROSSOVER STRATEGY EXPLAINED ===
#
# 1. GOLDEN CROSS (Entry Signal)
#    - Fast EMA crosses above Slow EMA
#    - Indicates momentum shift to bullish
#    - We wait for pullback (price < fast EMA) for better entry
#
# 2. DEATH CROSS (Exit Signal)
#    - Fast EMA crosses below Slow EMA
#    - Indicates momentum shift to bearish
#    - Exit immediately to protect profits
#
# 3. FIXED-POINT ARITHMETIC
#    - All calculations use bv[16] scaled by 256
#    - α=0.2 becomes 51/256, (1-α)=0.8 becomes 205/256
#    - Division by 256 is efficient (right shift by 8)
#
# EXPECTED BEHAVIOR:
# - Trending markets: Catch major moves early, ride them
# - Choppy markets: May whipsaw (false signals)
# - Flash crashes: Quick exit on death cross

# === INITIALIZATION ===
# EMAs start at 0, will converge to market price over first ~20 ticks
# Alternative: Initialize to first price value
# o15[0] = i0[0], o16[0] = i0[0]

# === PERFORMANCE NOTES ===
# - 3 additional bitvector operations per tick
# - EMA calculation: 2 multiplications, 1 addition, 1 division
# - Crossover check: 1 comparison
# - Total clauses: 14 (up from 11 in V42)
# - SMT impact: ~20-30% slower due to arithmetic

# === SAFETY GUARANTEES (Preserved) ===
# 1. Action exclusivity: Buy/Sell mutually exclusive
# 2. Fresh oracle: Volume required for entry/continuation
# 3. Nonce blocking: No immediate re-entry
# 4. Timeout: Timer still enforces max hold time
# 5. Profit coupling: Burns require actual profit

