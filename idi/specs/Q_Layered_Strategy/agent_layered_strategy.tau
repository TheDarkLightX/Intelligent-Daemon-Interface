# Layered Strategy Agent (file-based IO, Tau 0.7.0-alpha)
#
# Inputs:
#   i0 : price_up (1 when price tick up)
#   i1 : price_down (1 when price tick down)
#   i2 : weight_momentum (1=trust momentum layer)
#   i3 : weight_contra (1=trust contrarian layer)
#   i4 : weight_trend (1=trust trend layer)
#
# Outputs:
#   o0 : buy_signal
#   o1 : sell_signal
#   o2 : position bit
#   o3/o4/o5 : layer votes
#   o6-oA : input mirrors

i0:sbf = in file("inputs/price_up.in").
i1:sbf = in file("inputs/price_down.in").
i2:sbf = in file("inputs/weight_momentum.in").
i3:sbf = in file("inputs/weight_contra.in").
i4:sbf = in file("inputs/weight_trend.in").

# Mirror outputs for interpreter bookkeeping
i0:sbf = out file("outputs/i0_mirror.out").
i1:sbf = out file("outputs/i1_mirror.out").
i2:sbf = out file("outputs/i2_mirror.out").
i3:sbf = out file("outputs/i3_mirror.out").
i4:sbf = out file("outputs/i4_mirror.out").

o0:sbf = out file("outputs/buy_signal.out").
o1:sbf = out file("outputs/sell_signal.out").
o2:sbf = out file("outputs/position.out").
o3:sbf = out file("outputs/momentum_vote.out").
o4:sbf = out file("outputs/contrarian_vote.out").
o5:sbf = out file("outputs/trend_vote.out").
o6:sbf = out file("outputs/price_up_echo.out").
o7:sbf = out file("outputs/price_down_echo.out").
o8:sbf = out file("outputs/weight_momentum_echo.out").
o9:sbf = out file("outputs/weight_contra_echo.out").
oA:sbf = out file("outputs/weight_trend_echo.out").

r
(
    # Layer votes
    (o3[t] =
        (i0[t] & i0[t-1] & o2[t-1]') |
        (i1[t] & i1[t-1] & o2[t-1])
    ) &&

    (o4[t] =
        (i1[t] & o2[t-1]') |
        (i0[t] & o2[t-1])
    ) &&

    (o5[t] =
        (i0[t] & o2[t-1]') |
        (i1[t] & o2[t-1])
    ) &&

    # Action selection (gated by layer weights)
    (o0[t] =
        o2[t-1]' &
        (
            (i2[t] & o3[t] & i0[t]) |
            (i3[t] & o4[t] & i1[t]) |
            (i4[t] & o5[t] & i0[t])
        )
    ) &&

    (o1[t] =
        o2[t-1] &
        (
            (i2[t] & o3[t] & i1[t]) |
            (i3[t] & o4[t] & i0[t]) |
            (i4[t] & o5[t] & i1[t])
        )
    ) &&

    (o2[t] =
        o0[t] |
        (o2[t-1] & o1[t]')
    ) &&

    # Input mirrors for Tau 0.7.0 symmetric I/O requirement
    (o6[t] = i0[t]) &&
    (o7[t] = i1[t]) &&
    (o8[t] = i2[t]) &&
    (o9[t] = i3[t]) &&
    (oA[t] = i4[t])
).

