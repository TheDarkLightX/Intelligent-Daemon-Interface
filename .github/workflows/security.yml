name: Security (Python Dependencies)

on:
  push:
    branches: [main]
    paths:
      - "pyproject.toml"
      - "uv.lock"
      - "idi/**"
      - ".github/workflows/**"
  pull_request:
    branches: [main]
    paths:
      - "pyproject.toml"
      - "uv.lock"
      - "idi/**"
      - ".github/workflows/**"
  workflow_dispatch:

jobs:
  python-deps-security:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: .

    env:
      UV_PROJECT: ${{ github.workspace }}

    steps:
      - uses: actions/checkout@v4

      - name: Show checkout context
        run: |
          pwd
          ls -la
          echo "---- pyproject.toml (root) ----"
          sed -n '1,40p' "${{ github.workspace }}/pyproject.toml"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        run: |
          python -m pip install --upgrade pip
          python -m pip install "uv==0.7.13"
          uv --version

      - name: Show project context
        run: |
          pwd
          sed -n '1,30p' "${{ github.workspace }}/pyproject.toml"

      - name: Verify lockfile is up to date
        run: uv lock --check --project "${{ github.workspace }}"

      - name: Install locked dependencies
        run: uv sync --locked --extra dev --extra gui --project "${{ github.workspace }}"

      - name: Run IAN test suite
        run: uv run python -m pytest idi/ian/tests -q

      - name: Dependency vulnerability scan (OSV)
        env:
          PIP_AUDIT_VULNERABILITY_SERVICE: osv
          PIP_AUDIT_PROGRESS_SPINNER: off
        run: uv run pip-audit --local

      - name: Generate SBOM (CycloneDX)
        run: |
          uv pip install cyclonedx-bom
          uv run cyclonedx-py environment \
            --output-format json \
            --outfile sbom.json
          echo "SBOM generated: sbom.json"

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom.json
          retention-days: 90

      - name: SBOM validation
        run: |
          # Verify SBOM is valid JSON and has expected structure
          python -c "
          import json
          with open('sbom.json') as f:
              sbom = json.load(f)
          assert 'bomFormat' in sbom, 'Missing bomFormat'
          assert sbom['bomFormat'] == 'CycloneDX', 'Invalid format'
          assert 'components' in sbom, 'Missing components'
          print(f'SBOM valid: {len(sbom[\"components\"])} components')
          "
