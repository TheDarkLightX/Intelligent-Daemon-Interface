name: Security (Python Dependencies)

on:
  push:
    branches: [main]
    paths:
      - "pyproject.toml"
      - "uv.lock"
      - "idi/**"
      - ".github/workflows/**"
  pull_request:
    branches: [main]
    paths:
      - "pyproject.toml"
      - "uv.lock"
      - "idi/**"
      - ".github/workflows/**"
  workflow_dispatch:

jobs:
  python-deps-security:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: .

    env:
      UV_PROJECT: ${{ github.workspace }}

    steps:
      - uses: actions/checkout@v4

      - name: Show checkout context
        run: |
          pwd
          ls -la
          echo "---- pyproject.toml (root) ----"
          sed -n '1,40p' "${{ github.workspace }}/pyproject.toml"

      - name: Validate pyproject discovery
        run: |
          python - <<'PY'
          from __future__ import annotations

          from pathlib import Path
          import sys
          import tomllib

          root = Path("${{ github.workspace }}")

          offenders: list[Path] = []
          for path in sorted(root.rglob("pyproject.toml")):
              try:
                  data = tomllib.loads(path.read_text(encoding="utf-8"))
              except Exception as exc:  # pragma: no cover
                  print(f"PARSE_FAIL: {path.relative_to(root)}: {exc}")
                  offenders.append(path)
                  continue

              project = data.get("project")
              name = project.get("name") if isinstance(project, dict) else None
              if not name:
                  print(f"MISSING project.name: {path.relative_to(root)}")
                  offenders.append(path)
                  continue

          if offenders:
              print("\nOffending pyproject.toml files detected; refusing to continue.")
              sys.exit(2)

          root_data = tomllib.loads((root / "pyproject.toml").read_text(encoding="utf-8"))
          print("\nRoot project.name:", root_data.get("project", {}).get("name"))
          PY

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        run: |
          python -m pip install --upgrade pip
          python -m pip install "uv==0.7.13"
          uv --version

      - name: Show project context
        run: |
          pwd
          sed -n '1,30p' "${{ github.workspace }}/pyproject.toml"

      - name: Verify lockfile is up to date
        run: uv lock --check --project "${{ github.workspace }}"

      - name: Install locked dependencies
        run: uv sync --locked --extra dev --extra gui --project "${{ github.workspace }}"

      - name: Run IAN test suite
        run: uv run --project "${{ github.workspace }}" python -m pytest idi/ian/tests -q

      - name: Dependency vulnerability scan (OSV)
        env:
          PIP_AUDIT_VULNERABILITY_SERVICE: osv
          PIP_AUDIT_PROGRESS_SPINNER: off
        run: uv run --project "${{ github.workspace }}" pip-audit --local

      - name: Generate SBOM (CycloneDX)
        run: |
          uv pip install --project "${{ github.workspace }}" cyclonedx-bom
          uv run --project "${{ github.workspace }}" cyclonedx-py environment \
            --output-format json \
            --outfile sbom.json
          echo "SBOM generated: sbom.json"

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom.json
          retention-days: 90

      - name: SBOM validation
        run: |
          # Verify SBOM is valid JSON and has expected structure
          python -c "
          import json
          with open('sbom.json') as f:
              sbom = json.load(f)
          assert 'bomFormat' in sbom, 'Missing bomFormat'
          assert sbom['bomFormat'] == 'CycloneDX', 'Invalid format'
          assert 'components' in sbom, 'Missing components'
          print(f'SBOM valid: {len(sbom[\"components\"])} components')
          "
